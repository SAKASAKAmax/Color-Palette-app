<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palette Studio - ノンデザイナーのためのスライド用カラーパレット生成サービス</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sf-font@1.0.0/dist/sf-font.css">
    <style>
        body {
            font-family: 'SF Pro Display', 'SF Pro Text', 'Inter', 'Noto Sans JP', 'Helvetica Neue', 'Arial', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: url('background.png') center center / cover no-repeat fixed;
            color: #222;
        }
        /* Apple系クラス名をps-にリネーム */
        .ps-card {
            background: #fff;
            border-radius: 28px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.06), 0 1.5px 4px 0 rgba(0,0,0,0.03);
            padding: 2.5rem 2rem;
        }
        .ps-header, .ps-sub {
            position: static;
            z-index: auto;
        }
        .ps-header::before, .ps-sub::before {
            content: none;
        }
        .ps-header {
            font-size: 2.7rem;
            font-weight: 800;
            letter-spacing: -0.01em;
            color: #fff;
            background: none;
            text-shadow: 0 4px 24px rgba(0,0,0,0.32), 0 1.5px 4px rgba(0,0,0,0.18);
            border-radius: 0;
            padding: 0.1em 0 0.1em 0;
            display: block;
            margin-bottom: 0.1em;
            line-height: 1.1;
            text-align: left;
        }
        .ps-sub {
            color: #f3f6fa;
            font-size: 1.25rem;
            font-weight: 500;
            line-height: 1.7;
            background: none;
            text-shadow: 0 2px 8px rgba(0,0,0,0.28), 0 1px 1px rgba(0,0,0,0.12);
            border-radius: 0;
            padding: 0.2em 0 0.2em 0;
            margin-top: 0.2em;
            display: block;
            max-width: 90vw;
            text-align: left;
        }
        .ps-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.3rem;
        }
        .ps-input, .ps-hex {
            border-radius: 12px;
            border: 1.5px solid #e0e0e0;
            background: #f9f9fa;
            font-size: 1rem;
            padding: 0.7rem 1rem;
            font-family: inherit;
            transition: border 0.2s;
        }
        .ps-input:focus, .ps-hex:focus {
            border: 1.5px solid #0071e3;
            outline: none;
        }
        .ps-btn {
            background: #0071e3;
            color: #fff;
            border-radius: 12px;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
            transition: background 0.2s;
            box-shadow: 0 1.5px 4px 0 rgba(0,0,0,0.03);
        }
        .ps-btn:hover {
            background: #005bb5;
        }
        .ps-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #222;
            margin-bottom: 1rem;
        }
        .ps-swatch {
            border-radius: 16px;
            box-shadow: 0 1.5px 4px 0 rgba(0,0,0,0.04);
        }
        .ps-copy-feedback {
            background: #0071e3;
            color: #fff;
            border-radius: 8px;
            font-size: 0.9rem;
            padding: 2px 10px;
        }
        .ps-range::-webkit-slider-thumb {
            background: #0071e3;
        }
        .ps-range::-moz-range-thumb {
            background: #0071e3;
        }
        /* スライダーの見た目をカスタム */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        .copy-feedback {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        .swatch-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            pointer-events: none;
            opacity: 0.8;
        }
        .ps-toast {
            position: fixed;
            left: 50%;
            bottom: 40px;
            transform: translateX(-50%) scale(1);
            min-width: 220px;
            max-width: 90vw;
            background: rgba(34, 34, 34, 0.95);
            color: #fff;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 16px;
            box-shadow: 0 6px 32px 0 rgba(0,0,0,0.18), 0 1.5px 4px 0 rgba(0,0,0,0.08);
            padding: 1rem 2.2rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s cubic-bezier(.4,0,.2,1), transform 0.35s cubic-bezier(.4,0,.2,1);
        }
        .ps-toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) scale(1.04);
        }
        .ps-toast.success {
            background: linear-gradient(90deg, #10B981 0%, #22D3EE 100%);
            color: #fff;
        }
        .ps-toast.error {
            background: linear-gradient(90deg, #EF4444 0%, #F59E42 100%);
            color: #fff;
        }
        .ps-toast.code {
            background: #222;
            color: #fff;
        }
        #backgroundSuggestions button {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5em;
            min-height: 2.5em;
            font-size: 0.95em;
        }
        #backgroundSuggestions .copy-hex-btn, #backgroundSuggestions .text-hex-btn, #backgroundSuggestions .dl-hex-btn {
            background: none;
            border: none;
            padding: 0 0.2em;
            cursor: pointer;
            opacity: 0.7;
            font-size: 0.95em;
            transition: opacity 0.2s;
        }
        #backgroundSuggestions .copy-hex-btn:hover, #backgroundSuggestions .text-hex-btn:hover, #backgroundSuggestions .dl-hex-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen text-[#222]">

    <div class="w-full h-full px-0 md:px-8 py-4 md:py-12">
        <header class="mb-10 md:mb-14 w-full">
            <h1 class="ps-header text-5xl md:text-6xl tracking-tight mb-2 drop-shadow-sm pl-6 pt-4">Palette Studio</h1>
            <p class="ps-sub text-xl md:text-2xl max-w-2xl pl-6">ノンデザイナーのためのスライド資料特化カラーパレット生成サービス</p>
        </header>
        <main class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 w-full">
            <!-- 設定パネル -->
            <section class="ps-card shadow-xl flex flex-col h-fit rounded-none sticky top-8">
                <h2 class="ps-section-title text-2xl mb-6 flex items-center gap-2"><svg width="28" height="28" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#f5f6fa" stroke="#0071e3" stroke-width="2"/><path d="M8 12a4 4 0 108 0 4 4 0 00-8 0z" fill="#0071e3"/></svg> カラー設定</h2>
                <div class="space-y-8 flex-1">
                    <div>
                        <label for="startColor" class="ps-label">最も濃い色 (始点)</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="startColor" value="#000000" class="h-12 w-16 border-0 rounded-lg cursor-pointer ps-input shadow-sm">
                            <input type="text" id="startColorHex" value="#000000" maxlength="7" class="ps-hex w-32 text-center text-lg tracking-widest" placeholder="#000000">
                        </div>
                        <span id="startColorHexError" class="text-xs text-red-500 hidden">無効なHex形式です</span>
                    </div>
                    <div>
                        <label for="endColor" class="ps-label">最も薄い色 (終点)</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="endColor" value="#FFFFFF" class="h-12 w-16 border-0 rounded-lg cursor-pointer ps-input shadow-sm">
                            <input type="text" id="endColorHex" value="#FFFFFF" maxlength="7" class="ps-hex w-32 text-center text-lg tracking-widest" placeholder="#FFFFFF">
                        </div>
                        <span id="endColorHexError" class="text-xs text-red-500 hidden">無効なHex形式です</span>
                    </div>
                    <div>
                        <label for="colorCount" class="ps-label">色の数: <span id="colorCountValue" class="font-bold text-[#0071e3]">6</span></label>
                        <div class="flex items-center gap-2 mt-2">
                            <button id="colorCountDecrement" class="ps-btn px-3 py-1 text-lg">-</button>
                            <input type="number" id="colorCountInput" min="3" max="12" value="6" class="ps-hex w-20 text-center text-lg">
                            <button id="colorCountIncrement" class="ps-btn px-3 py-1 text-lg">+</button>
                            <input type="range" id="colorCount" min="3" max="12" value="6" class="w-full h-2 bg-[#e5e7eb] rounded-lg appearance-none cursor-pointer ps-range ml-4">
                        </div>
                    </div>
                </div>
                <div class="mt-10">
                    <h2 class="ps-section-title text-xl mb-4 flex items-center gap-2"><svg width="22" height="22" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="5" fill="#e9ebf0" stroke="#0071e3" stroke-width="2"/></svg> 背景色の提案</h2>
                    <div id="backgroundSuggestions" class="grid grid-cols-2 gap-3">
                        <!-- 背景色ボタンがここに動的に追加されます -->
                    </div>
                    <div id="bgHexCopyArea" class="mt-2"></div>
                </div>
            </section>
            <!-- 結果表示エリア -->
            <section class="flex flex-col gap-8 col-span-2">
                <!-- 生成されたカラーパレット -->
                <div class="ps-card shadow-xl mb-8 rounded-none">
                    <h2 class="ps-section-title text-2xl mb-4 flex items-center gap-2"><svg width="28" height="28" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="5" fill="#f5f6fa" stroke="#0071e3" stroke-width="2"/></svg> 生成されたカラーパレット</h2>
                    <p class="text-base text-[#888] mb-6">各色の「Aa」は、その背景色に対して推奨されるテキスト色（白/黒）を示します。</p>
                    <div id="palette" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-6">
                        <!-- カラーチップがここに動的に追加されます -->
                    </div>
                    <div class="mt-8 text-center">
                        <button id="exportSvgButton" class="ps-btn flex items-center justify-center mx-auto gap-2 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>SVG画像をダウンロード</button>
                    </div>
                </div>
                <!-- アクセントカラーの提案 -->
                <div class="ps-card shadow-xl mb-8 rounded-none">
                    <h2 class="ps-section-title text-2xl mb-4 flex items-center gap-2"><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#e9ebf0" stroke="#0071e3" stroke-width="2"/><path d="M12 7v5l3 3" stroke="#0071e3" stroke-width="2" stroke-linecap="round"/></svg> アクセントカラーの提案</h2>
                    <p class="text-base text-[#888] mb-6">パレットのメインカラーを引き立てる差し色です。グラフやボタンの強調に効果的です。</p>
                    <div id="accentColorContainer" class="flex items-center gap-8">
                        <!-- アクセントカラーがここに動的に追加されます -->
                    </div>
                </div>
                <!-- プレビューエリア -->
                <div class="ps-card shadow-xl mb-8 rounded-none">
                    <h2 class="ps-section-title text-2xl mb-4 flex items-center gap-2"><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="5" fill="#e9ebf0" stroke="#0071e3" stroke-width="2"/></svg> プレビュー</h2>
                    <!-- プレビュー注意書き（カード内・タイトル下） -->
                    <div class="flex justify-end items-center mb-4">
                        <span class="inline-flex items-center bg-[#f3f6fa] text-[#4b5563] border border-[#e5e7eb] rounded-full px-3 py-1 text-xs font-medium shadow-sm select-none" style="backdrop-filter: blur(2px); margin-right: 0.5rem;">
                            <svg class="w-3.5 h-3.5 mr-1.5 text-[#f59e42]" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm.75 11.25a.75.75 0 01-1.5 0v-3.5a.75.75 0 011.5 0v3.5zm-.75-6a1 1 0 110 2 1 1 0 010-2z"/></svg>
                            プレビューは架空スライドの資料例です
                        </span>
                    </div>
                    <div id="preview" class="w-full aspect-[16/9] rounded-2xl transition-colors duration-300 flex flex-col overflow-hidden border border-[#e5e7eb] bg-gradient-to-br from-[#fafdff] to-[#f5f6fa]">
                        <!-- Header/Title Section -->
                        <div class="p-8 md:p-10" id="previewHeader">
                            <p id="previewSubtitle" class="text-base font-semibold uppercase tracking-wider"></p>
                            <h3 id="previewTitle" class="text-3xl md:text-4xl font-bold mt-1"></h3>
                        </div>
                        <!-- Main Content Area: Gantt Chart -->
                        <div class="flex-grow px-8 md:px-10 py-6 flex flex-col">
                            <h4 id="previewSectionTitle" class="text-lg font-bold mb-4">実行タイムライン</h4>
                            <div id="previewGantt" class="flex-grow text-base space-y-2">
                                <!-- Gantt chart content will be generated here -->
                            </div>
                        </div>
                        <!-- Footer / Key Takeaway -->
                        <div class="mt-auto p-6 md:p-8" id="previewFooter">
                            <p id="previewTakeawayTitle" class="font-bold text-base">Key Takeaway:</p>
                            <p id="previewTakeawayText" class="text-base">キーメッセージをここに簡潔に記述します。</p>
                        </div>
                    </div>
                </div>
                <!-- SVGコードプレビューセクション -->
                <div class="ps-card shadow-xl rounded-none">
                    <h2 class="ps-section-title text-2xl mb-4 flex items-center gap-2"><svg width="24" height="24" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="5" fill="#e9ebf0" stroke="#0071e3" stroke-width="2"/></svg> SVG プレビュー & コード</h2>
                    <p class="text-base text-[#888] mb-6">上のツールで生成されたSVGコードが表示されます。ここに直接SVGコードを貼り付けてプレビューすることも可能です。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="svgCodeTextarea" class="ps-label mb-2 block">SVG コード</label>
                            <textarea id="svgCodeTextarea" class="w-full h-48 p-3 border border-[#e5e7eb] rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] font-mono text-base bg-[#fafdff] resize-none" spellcheck="false"></textarea>
                        </div>
                        <div>
                            <label class="ps-label mb-2 block">ライブプレビュー</label>
                            <div id="svgLivePreview" class="w-full h-48 p-3 border border-[#e5e7eb] rounded-xl bg-[#fafdff] flex items-center justify-center overflow-auto"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- トースト通知 -->
    <div id="psToast" class="ps-toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI要素の取得
            const startColorInput = document.getElementById('startColor');
            const startColorHexInput = document.getElementById('startColorHex');
            const endColorInput = document.getElementById('endColor');
            const endColorHexInput = document.getElementById('endColorHex');
            const colorCountSlider = document.getElementById('colorCount');
            const colorCountValue = document.getElementById('colorCountValue');
            const colorCountInput = document.getElementById('colorCountInput');
            const colorCountDecrement = document.getElementById('colorCountDecrement');
            const colorCountIncrement = document.getElementById('colorCountIncrement');
            const paletteContainer = document.getElementById('palette');
            const backgroundSuggestionsContainer = document.getElementById('backgroundSuggestions');
            const accentColorContainer = document.getElementById('accentColorContainer');
            const exportSvgButton = document.getElementById('exportSvgButton');
            const svgCodeTextarea = document.getElementById('svgCodeTextarea');
            const svgLivePreview = document.getElementById('svgLivePreview');
            const psToast = document.getElementById('psToast');
            
            // プレビュー要素
            const preview = document.getElementById('preview');
            const previewHeader = document.getElementById('previewHeader');
            const previewSubtitle = document.getElementById('previewSubtitle');
            const previewTitle = document.getElementById('previewTitle');
            const previewSectionTitle = document.getElementById('previewSectionTitle');
            const previewGantt = document.getElementById('previewGantt');
            const previewFooter = document.getElementById('previewFooter');
            const previewTakeawayTitle = document.getElementById('previewTakeawayTitle');
            const previewTakeawayText = document.getElementById('previewTakeawayText');

            // 現在のパレットを保持する変数
            let currentPalette = [];
            let currentAccentColor = '#FF0000';

            // --- ヘルパー関数 ---

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
            }

            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }

            function rgbToHsl(rgb) {
                let r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
                let max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max == min) { h = s = 0; } else {
                    let d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h: h * 360, s: s, l: l };
            }

            function hslToRgb(hsl) {
                let h = hsl.h, s = hsl.s, l = hsl.l;
                let r, g, b;
                if (s == 0) { r = g = b = l; } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    }
                    let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    let p = 2 * l - q;
                    h /= 360;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
            }
            
            function interpolateColor(color1, color2, factor) {
                return {
                    r: Math.round(color1.r + factor * (color2.r - color1.r)),
                    g: Math.round(color1.g + factor * (color2.g - color1.g)),
                    b: Math.round(color1.b + factor * (color2.b - color1.b))
                };
            }

            function getLuminance(rgb) {
                return (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            }

            function generateAndDisplay() {
                const startRgb = hexToRgb(startColorInput.value);
                const endRgb = hexToRgb(endColorInput.value);
                const count = parseInt(colorCountSlider.value, 10);

                if (!startRgb || !endRgb) {
                    paletteContainer.innerHTML = '<p class="text-red-500 col-span-full">有効なカラーコードを入力してください。</p>';
                    return;
                }

                const palette = [];
                for (let i = 0; i < count; i++) {
                    const factor = (count === 1) ? 0 : i / (count - 1);
                    const interpolatedRgb = interpolateColor(startRgb, endRgb, factor);
                    palette.push({
                        hex: rgbToHex(interpolatedRgb.r, interpolatedRgb.g, interpolatedRgb.b),
                        rgb: `rgb(${interpolatedRgb.r}, ${interpolatedRgb.g}, ${interpolatedRgb.b})`,
                        rawRgb: interpolatedRgb
                    });
                }
                currentPalette = palette;
                updatePaletteDisplay(palette);
                updateBackgroundSuggestions(palette);
                updateAccentColor(palette);
                updatePreview(palette, preview.style.backgroundColor || 'rgb(255, 255, 255)');
                updateSvgSection(palette);
            }

            function updatePaletteDisplay(palette) {
                paletteContainer.innerHTML = '';
                palette.forEach(color => {
                    const colorEl = document.createElement('div');
                    colorEl.className = 'relative';
                    const swatch = document.createElement('div');
                    swatch.className = 'w-full aspect-square rounded-lg shadow relative';
                    swatch.style.backgroundColor = color.hex;

                    const luminance = getLuminance(color.rawRgb);
                    const textColor = luminance > 128 ? '#000000' : '#FFFFFF';

                    const textEl = document.createElement('div');
                    textEl.className = 'swatch-text';
                    textEl.style.color = textColor;
                    textEl.textContent = 'Aa';
                    swatch.appendChild(textEl);
                    
                    const info = document.createElement('div');
                    info.className = 'text-left mt-2';
                    info.innerHTML = `<p class="font-semibold text-sm">${color.hex}</p>`; // Hexのみ表示
                    
                    const copyButton = document.createElement('button');
                    copyButton.textContent = 'コピー';
                    copyButton.className = 'mt-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-1 px-2 rounded-md transition-colors';
                    
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'copy-feedback';
                    feedbackEl.textContent = 'コピーしました!';

                    copyButton.onclick = (e) => {
                        e.stopPropagation();
                        const textarea = document.createElement('textarea');
                        textarea.value = color.hex;
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            feedbackEl.style.opacity = '1';
                            feedbackEl.style.transform = 'translateX(-50%) translateY(-10px)';
                            setTimeout(() => {
                                feedbackEl.style.opacity = '0';
                                feedbackEl.style.transform = 'translateX(-50%)';
                            }, 1500);
                        } catch (err) { console.error('コピーに失敗しました', err); }
                        document.body.removeChild(textarea);
                    };

                    info.appendChild(copyButton);
                    colorEl.appendChild(swatch);
                    colorEl.appendChild(info);
                    colorEl.appendChild(feedbackEl);
                    paletteContainer.appendChild(colorEl);
                });
            }
            
            function updateAccentColor(palette) {
                accentColorContainer.innerHTML = '';
                if (palette.length === 0) return;

                const baseColorHsl = rgbToHsl(palette[0].rawRgb);
                const accentHsl = {
                    h: (baseColorHsl.h + 180) % 360,
                    s: Math.max(0.6, baseColorHsl.s), 
                    l: 0.55
                };
                const accentRgb = hslToRgb(accentHsl);
                currentAccentColor = rgbToHex(accentRgb.r, accentRgb.g, accentRgb.b);

                const swatch = document.createElement('div');
                swatch.className = 'w-16 h-16 rounded-lg shadow-md';
                swatch.style.backgroundColor = currentAccentColor;

                const info = document.createElement('div');
                info.innerHTML = `
                    <p class="font-bold text-lg">${currentAccentColor}</p>
                `; // Hexのみ表示
                
                accentColorContainer.appendChild(swatch);
                accentColorContainer.appendChild(info);
            }

            function updateBackgroundSuggestions(palette) {
                backgroundSuggestionsContainer.innerHTML = '';
                const endColorHsl = rgbToHsl(palette[palette.length - 1].rawRgb);
                const softTintRgb = hslToRgb({ h: endColorHsl.h, s: Math.max(0, endColorHsl.s - 0.2), l: 0.97 });
                const startColorHsl = rgbToHsl(palette[0].rawRgb);
                const complementaryRgb = hslToRgb({ h: (startColorHsl.h + 180) % 360, s: 0.15, l: 0.96 });
                const suggestions = [
                    { name: 'White', hex: '#FFFFFF', rgb: {r: 255, g: 255, b: 255}},
                    { name: 'Dark Gray', hex: '#1F2937', rgb: {r: 31, g: 41, b: 55}},
                    { name: 'やさしい色合い', hex: rgbToHex(softTintRgb.r, softTintRgb.g, softTintRgb.b), rgb: softTintRgb},
                    { name: '上品なアクセント', hex: rgbToHex(complementaryRgb.r, complementaryRgb.g, complementaryRgb.b), rgb: complementaryRgb}
                ];

                suggestions.forEach(bg => {
                    const button = document.createElement('button');
                    const luminance = getLuminance(bg.rgb);
                    // テキスト色はインラインstyleで明示
                    button.className = 'w-full p-3 rounded-lg text-sm font-medium transition-transform transform hover:scale-105';
                    button.style.backgroundColor = bg.hex;
                    button.style.color = luminance > 128 ? '#111' : '#fff';
                    button.textContent = `${bg.name} (${bg.hex})`;
                    button.onclick = () => {
                        // プレビューの背景色をしっかり上書き（クラスも除去）
                        preview.style.backgroundColor = bg.hex;
                        preview.classList.remove('bg-gradient-to-br', 'from-[#fafdff]', 'to-[#f5f6fa]');
                        updatePreview(palette, `rgb(${bg.rgb.r}, ${bg.rgb.g}, ${bg.rgb.b})`);
                    };
                    backgroundSuggestionsContainer.appendChild(button);
                });
            }

            function updatePreview(palette, backgroundRgbString) {
                if(palette.length === 0) return;

                const bgRgb = backgroundRgbString.match(/\d+/g).map(Number);
                const bgLuminance = getLuminance({r: bgRgb[0], g: bgRgb[1], b: bgRgb[2]});
                const primaryTextColor = bgLuminance > 128 ? 'text-slate-900' : 'text-white';
                const secondaryTextColor = bgLuminance > 128 ? 'text-slate-600' : 'text-slate-300';
                const mutedTextColor = bgLuminance > 128 ? 'text-slate-400' : 'text-slate-500';

                // Header
                previewHeader.style.borderColor = palette[Math.min(2, palette.length -1)].hex;
                previewSubtitle.textContent = '実行計画';
                previewSubtitle.style.color = palette[1].hex;
                previewTitle.textContent = 'プロダクトローンチ計画';
                previewTitle.style.color = palette[0].hex;

                // Main content: Gantt Chart
                previewSectionTitle.className = `text-lg font-bold mb-4 ${primaryTextColor}`;
                previewGantt.innerHTML = '';
                
                // Gantt Header
                const ganttHeader = document.createElement('div');
                ganttHeader.className = `grid grid-cols-12 text-center text-xs font-bold ${mutedTextColor} pr-2`;
                ganttHeader.innerHTML = `
                    <div class="col-span-3">Q1</div>
                    <div class="col-span-3">Q2</div>
                    <div class="col-span-3">Q3</div>
                    <div class="col-span-3">Q4</div>
                `;
                const timeline = document.createElement('div');
                timeline.className = 'relative mt-1 h-px w-full';
                timeline.style.backgroundColor = bgLuminance > 128 ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                
                previewGantt.appendChild(ganttHeader);
                previewGantt.appendChild(timeline);
                
                // Gantt Rows
                const tasks = [
                    { name: 'リサーチ & 分析', start: 0, duration: 25 },
                    { name: 'UX/UI デザイン', start: 25, duration: 25 },
                    { name: '開発フェーズ１', start: 25, duration: 40 },
                    { name: 'マーケティング準備', start: 50, duration: 40 },
                    { name: 'ローンチ', start: 90, duration: 10 },
                ];

                tasks.forEach((task, i) => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center mt-2';
                    const label = document.createElement('div');
                    label.className = `w-1/3 text-xs md:text-sm pr-4 truncate ${secondaryTextColor}`;
                    label.textContent = task.name;

                    const barContainer = document.createElement('div');
                    barContainer.className = 'w-2/3 h-6 relative';
                    
                    const bar = document.createElement('div');
                    bar.className = 'h-full rounded transition-all duration-300';
                    bar.style.position = 'absolute';
                    bar.style.left = `${task.start}%`;
                    bar.style.width = `${task.duration}%`;
                    bar.style.backgroundColor = task.name === 'ローンチ' ? currentAccentColor : palette[i % palette.length].hex;
                    
                    barContainer.appendChild(bar);
                    row.appendChild(label);
                    row.appendChild(barContainer);
                    previewGantt.appendChild(row);
                });

                // Footer
                const footerBgRgb = interpolateColor({r:255,g:255,b:255}, bgRgb, 0.2);
                previewFooter.style.backgroundColor = `rgba(${footerBgRgb.r}, ${footerBgRgb.g}, ${footerBgRgb.b}, 0.5)`;
                const footerTextLuminance = getLuminance(footerBgRgb);
                previewTakeawayTitle.style.color = palette[0].hex;
                previewTakeawayText.className = `text-sm ${footerTextLuminance > 128 ? 'text-slate-700' : 'text-slate-100'}`;
            }

            function generateSvgString(palette) {
                if (palette.length === 0) return '';
                const rectWidth = 100;
                const rectHeight = 100;
                const textHeight = 28;
                const svgWidth = rectWidth * palette.length;
                const svgHeight = rectHeight + textHeight;
                const fontSize = 18;
                const rects = palette.map((color, index) => `<rect x="${index * rectWidth}" y="0" width="${rectWidth}" height="${rectHeight}" fill="${color.hex}" />`).join('');
                // Hexラベルを下部に横並びで
                const texts = palette.map((color, index) =>
                    `<text x="${index * rectWidth + rectWidth / 2}" y="${rectHeight + fontSize + 2}" text-anchor="middle" font-size="${fontSize}" font-family='Inter, "Noto Sans JP", sans-serif' fill="#222" font-weight="600">${color.hex}</text>`
                ).join('');
                return `<svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" version="1.1" xmlns="http://www.w3.org/2000/svg">${rects}${texts}</svg>`;
            }

            function updateSvgSection(palette) {
                const svgString = generateSvgString(palette);
                svgCodeTextarea.value = svgString;
                svgLivePreview.innerHTML = svgString;
            }

            // スタイリッシュなトースト表示関数
            function showToast(message, type = 'success', duration = 2200) {
                psToast.textContent = message;
                psToast.className = `ps-toast show ${type}`;
                setTimeout(() => {
                    psToast.classList.remove('show');
                }, duration);
            }

            // --- イベントリスナーの設定 ---
            [startColorInput, endColorInput, colorCountSlider].forEach(el => el.addEventListener('input', generateAndDisplay));

            // --- HEX入力欄の正規化・バリデーション共通関数 ---
            function normalizeHexInput(raw) {
                // 先頭の#を除去し、英大文字6桁HEXのみ抽出
                let val = raw.toUpperCase().replace(/[^0-9A-F]/g, '');
                if (val.length > 6) val = val.slice(0, 6);
                return '#' + val;
            }
            function isValidHex6(val) {
                return /^#[0-9A-F]{6}$/.test(val);
            }
            function handleHexInput(inputEl, colorInputEl, errorId, onValid) {
                const normalized = normalizeHexInput(inputEl.value);
                inputEl.value = normalized;
                if (isValidHex6(normalized)) {
                    colorInputEl.value = normalized;
                    document.getElementById(errorId).classList.add('hidden');
                    if (onValid) onValid();
                } else {
                    document.getElementById(errorId).classList.remove('hidden');
                }
            }
            function handleHexPaste(e, inputEl) {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                inputEl.value = normalizeHexInput(paste);
                // 入力イベントを発火して色更新
                inputEl.dispatchEvent(new Event('input', { bubbles: true }));
            }
            // --- イベントリスナー登録 ---
            startColorHexInput.addEventListener('paste', e => handleHexPaste(e, startColorHexInput));
            endColorHexInput.addEventListener('paste', e => handleHexPaste(e, endColorHexInput));
            startColorHexInput.addEventListener('input', () => handleHexInput(startColorHexInput, startColorInput, 'startColorHexError', generateAndDisplay));
            endColorHexInput.addEventListener('input', () => handleHexInput(endColorHexInput, endColorInput, 'endColorHexError', generateAndDisplay));
            startColorInput.addEventListener('input', () => {
                startColorHexInput.value = startColorInput.value.toUpperCase();
                document.getElementById('startColorHexError').classList.add('hidden');
            });
            endColorInput.addEventListener('input', () => {
                endColorHexInput.value = endColorInput.value.toUpperCase();
                document.getElementById('endColorHexError').classList.add('hidden');
            });

            colorCountSlider.addEventListener('input', () => {
                colorCountValue.textContent = colorCountSlider.value;
            });
            
            svgCodeTextarea.addEventListener('input', () => {
                svgLivePreview.innerHTML = svgCodeTextarea.value;
            });

            exportSvgButton.addEventListener('click', () => {
                if (currentPalette.length === 0) return;
                const svgString = generateSvgString(currentPalette);
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'palette.svg';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                showToast('SVG画像をダウンロードしました', 'success');
            });

            // --- 色の数UI連動 ---
            function syncColorCountUI(val) {
                const v = Math.max(3, Math.min(12, parseInt(val, 10) || 6));
                colorCountSlider.value = v;
                colorCountInput.value = v;
                colorCountValue.textContent = v;
                colorCountDecrement.disabled = v <= 3;
                colorCountIncrement.disabled = v >= 12;
            }
            colorCountSlider.addEventListener('input', () => {
                syncColorCountUI(colorCountSlider.value);
                generateAndDisplay();
            });
            colorCountInput.addEventListener('input', () => {
                syncColorCountUI(colorCountInput.value);
                generateAndDisplay();
            });
            colorCountDecrement.addEventListener('click', () => {
                let v = parseInt(colorCountInput.value, 10) || 6;
                if (v > 3) v--;
                syncColorCountUI(v);
                generateAndDisplay();
            });
            colorCountIncrement.addEventListener('click', () => {
                let v = parseInt(colorCountInput.value, 10) || 6;
                if (v < 12) v++;
                syncColorCountUI(v);
                generateAndDisplay();
            });
            // 初期値同期
            syncColorCountUI(6);

            // 初期表示
            generateAndDisplay();
            // プレビュー背景色を初期化（クラスも除去）
            preview.style.backgroundColor = '#FFFFFF';
            preview.classList.remove('bg-gradient-to-br', 'from-[#fafdff]', 'to-[#f5f6fa]');
            updateBackgroundSuggestions(currentPalette);
        });
    </script>
</body>
</html>
